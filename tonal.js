var harmonicColdColor = {
    r: 21,
    g: 101,
    b: 192
};

var harmonicWarmColor = {
    r: 239,
    g: 108,
    b: 0
};


var harmonicNeutralColor = {
    r: 225,
    g: 225,
    b: 225
};



var harmonicColors = [
  {
    Steps: 7,
    Valence: 0.069548693586698268,
    Potence: 0.820952380952381,
    SourceMinor: true,
    TargetMinor: true
  },
  {
    Steps: 10,
    Valence: 0.17706650831353915,
    Potence: 0.46476190476190476,
    SourceMinor: true,
    TargetMinor: true
  },
  {
    Steps: 6,
    Valence: 0.20794536817102136,
    Potence: 0.52761904761904765,
    SourceMinor: true,
    TargetMinor: true
  },
  {
    Steps: 1,
    Valence: 0.26138954869358666,
    Potence: 0.579047619047619,
    SourceMinor: true,
    TargetMinor: true
  },
  {
    Steps: 7,
    Valence: 0.27920427553444177,
    Potence: 0.6495238095238095,
    SourceMinor: false,
    TargetMinor: true
  },
  {
    Steps: 7,
    Valence: 0.3326484560570071,
    Potence: 0.88952380952380949,
    SourceMinor: true,
    TargetMinor: false
  },
  {
    Steps: 9,
    Valence: 0.24595011876484557,
    Potence: 0.48952380952380953,
    SourceMinor: true,
    TargetMinor: true
  },
  {
    Steps: 0,
    Valence: 0.26495249406175769,
    Potence: 0.53714285714285714,
    SourceMinor: false,
    TargetMinor: true
  },
  {
    Steps: 1,
    Valence: 0.26257719714964367,
    Potence: 0.48,
    SourceMinor: false,
    TargetMinor: true
  },
  {
    Steps: 8,
    Valence: 0.25070071258907362,
    Potence: 0.43809523809523809,
    SourceMinor: true,
    TargetMinor: true
  },
  {
    Steps: 4,
    Valence: 0.26851543942992873,
    Potence: 0.33904761904761904,
    SourceMinor: true,
    TargetMinor: true
  },
  {
    Steps: 11,
    Valence: 0.28039192399049878,
    Potence: 0.44380952380952382,
    SourceMinor: true,
    TargetMinor: true
  },
  {
    Steps: 11,
    Valence: 0.30058194774346791,
    Potence: 0.41333333333333333,
    SourceMinor: false,
    TargetMinor: true
  },
  {
    Steps: 0,
    Valence: 0.314833729216152,
    Potence: 0.52571428571428569,
    SourceMinor: true,
    TargetMinor: true
  },
  {
    Steps: 10,
    Valence: 0.33383610451306411,
    Potence: 0.43238095238095237,
    SourceMinor: false,
    TargetMinor: true
  },
  {
    Steps: 8,
    Valence: 0.34096199524940612,
    Potence: 0.42666666666666669,
    SourceMinor: false,
    TargetMinor: true
  },
  {
    Steps: 10,
    Valence: 0.37065320665083135,
    Potence: 0.47809523809523807,
    SourceMinor: true,
    TargetMinor: false
  },
  {
    Steps: 3,
    Valence: 0.3659026128266033,
    Potence: 0.4838095238095238,
    SourceMinor: true,
    TargetMinor: true
  },
  {
    Steps: 6,
    Valence: 0.38609263657957243,
    Potence: 0.54666666666666663,
    SourceMinor: false,
    TargetMinor: true
  },
  {
    Steps: 3,
    Valence: 0.45141330166270782,
    Potence: 0.48952380952380953,
    SourceMinor: false,
    TargetMinor: true
  },
  {
    Steps: 5,
    Valence: 0.43953681710213771,
    Potence: 0.52571428571428569,
    SourceMinor: true,
    TargetMinor: true
  },
  {
    Steps: 6,
    Valence: 0.45260095011876483,
    Potence: 0.53523809523809529,
    SourceMinor: true,
    TargetMinor: false
  },
  {
    Steps: 2,
    Valence: 0.46804038004750592,
    Potence: 0.34476190476190477,
    SourceMinor: true,
    TargetMinor: true
  },
  {
    Steps: 4,
    Valence: 0.481104513064133,
    Potence: 0.35238095238095241,
    SourceMinor: false,
    TargetMinor: true
  },
  {
    Steps: 9,
    Valence: 0.483479809976247,
    Potence: 0.4838095238095238,
    SourceMinor: false,
    TargetMinor: true
  },
  {
    Steps: 5,
    Valence: 0.50248218527315913,
    Potence: 0.54666666666666663,
    SourceMinor: false,
    TargetMinor: true
  },
  {
    Steps: 2,
    Valence: 0.52267220902612821,
    Potence: 0.44380952380952382,
    SourceMinor: false,
    TargetMinor: true
  },
  {
    Steps: 10,
    Valence: 0.55592636579572441,
    Potence: 0.4,
    SourceMinor: false,
    TargetMinor: false
  },
  {
    Steps: 9,
    Valence: 0.56067695961995234,
    Potence: 0.43619047619047618,
    SourceMinor: true,
    TargetMinor: false
  },
  {
    Steps: 6,
    Valence: 0.57611638954869349,
    Potence: 0.35809523809523808,
    SourceMinor: false,
    TargetMinor: false
  },
  {
    Steps: 4,
    Valence: 0.59274346793349164,
    Potence: 0.34095238095238095,
    SourceMinor: true,
    TargetMinor: false
  },
  {
    Steps: 2,
    Valence: 0.62599762470308784,
    Potence: 0.34666666666666668,
    SourceMinor: false,
    TargetMinor: false
  },
  {
    Steps: 3,
    Valence: 0.60461995249406164,
    Potence: 0.44,
    SourceMinor: false,
    TargetMinor: false
  },
  {
    Steps: 2,
    Valence: 0.62480997624703083,
    Potence: 0.41142857142857142,
    SourceMinor: true,
    TargetMinor: false
  },
  {
    Steps: 8,
    Valence: 0.61887173396674577,
    Potence: 0.48571428571428571,
    SourceMinor: true,
    TargetMinor: false
  },
  {
    Steps: 3,
    Valence: 0.6212470308788598,
    Potence: 0.57333333333333336,
    SourceMinor: true,
    TargetMinor: false
  },
  {
    Steps: 9,
    Valence: 0.65687648456057,
    Potence: 0.44190476190476191,
    SourceMinor: false,
    TargetMinor: false
  },
  {
    Steps: 7,
    Valence: 0.68656769596199518,
    Potence: 0.59238095238095234,
    SourceMinor: false,
    TargetMinor: false
  },
  {
    Steps: 1,
    Valence: 0.71625890736342035,
    Potence: 0.60761904761904761,
    SourceMinor: true,
    TargetMinor: false
  },
  {
    Steps: 0,
    Valence: 0.73763657957244644,
    Potence: 0.57333333333333336,
    SourceMinor: true,
    TargetMinor: false
  },
  {
    Steps: 11,
    Valence: 0.78751781472684079,
    Potence: 0.40190476190476193,
    SourceMinor: true,
    TargetMinor: false
  },
  {
    Steps: 11,
    Valence: 0.7780166270783847,
    Potence: 0.47428571428571431,
    SourceMinor: false,
    TargetMinor: false
  },
  {
    Steps: 4,
    Valence: 0.87184085510688825,
    Potence: 0.38476190476190475,
    SourceMinor: false,
    TargetMinor: false
  },
  {
    Steps: 0,
    Valence: 0.820771971496437,
    Potence: 0.540952380952381,
    SourceMinor: false,
    TargetMinor: false
  },
  {
    Steps: 8,
    Valence: 0.816021377672209,
    Potence: 0.61523809523809525,
    SourceMinor: false,
    TargetMinor: false
  },
  {
    Steps: 5,
    Valence: 0.88609263657957238,
    Potence: 0.61523809523809525,
    SourceMinor: false,
    TargetMinor: false
  },
  {
    Steps: 5,
    Valence: 0.8777790973871733,
    Potence: 0.62666666666666671,
    SourceMinor: true,
    TargetMinor: false
  },
  {
    Steps: 1,
    Valence: 0.90984560570071249,
    Potence: 0.72952380952380957,
    SourceMinor: false,
    TargetMinor: false
  }
];

/**
 * Chord highlight selector
 * @returns {} 
 */
function highlightChordsTonal() {
    if (circleParameters.tonicHighlightHarmonicQualityMode == HarmonicQualityMode.None)
        return false;

    switch (circleParameters.tonicHighlightHarmonicQualityMode) {
        case HarmonicQualityMode.PsychAffective:
            highlightChordsPsychoaffective();
            break;
        case HarmonicQualityMode.Modes:
            highlightChordsModes();
            break;

        case HarmonicQualityMode.Linear:
            highlightChordsLinear();
            break;
        
    default:
    }

    
    return true;
}

var activeTonalHighlightId = 'highlightmode-none';

var availableHighlightModes = {
    'highlightmode-none': HarmonicQualityMode.None,
    'highlightmode-linear': HarmonicQualityMode.Linear,
    'highlightmode-psychoaffective': HarmonicQualityMode.PsychAffective,
    'highlightmode-modes': HarmonicQualityMode.Modes,
};


function setHighlightMode(source) {
    _restrictToOneCheckbox("highlightmode", source, function (cb) {

        // Set chord mode
        if (cb.checked) {
            
            var newmode = availableHighlightModes[cb.id];

            if (newmode != circleParameters.tonicHighlightHarmonicQualityMode) {
                clearHighlights();
                var oldLegend = document.getElementById(activeTonalHighlightId + "-legend");

                if(oldLegend!=null)
                    document.getElementById(activeTonalHighlightId + "-legend").style.display = 'none';
            }

            circleParameters.tonicHighlightHarmonicQualityMode = newmode;
            activeTonalHighlightId = cb.id;

            var legend = document.getElementById(activeTonalHighlightId + "-legend");

            if(legend!=null)
                legend.style.display = 'block';

            redraw();
        }
    });
}

function clearHighlights() {
    for (let chord of chordDefinitions) {
        chord.highlight = ChordHighlightType.None;
    }
}

/**
 * 
 * @returns {} 
 */
function highlightChordsModes() {

    circleParameters.isTonicMinor = false;
    
    var tonic = chordDefinitions.find(_t => _t.isTonicChord(circleParameters.selectedTonic,
        circleParameters.isTonicMinor));

    for (let chord of chordDefinitions) {
        var relmode = chord.getRelativeMode(tonic);

        if (relmode == ModeDefinitions.None) {
            chord.highlight = ChordHighlightType.None;
            continue;
        }

        chord.highlight = ChordHighlightType.UnderlineModeQuality;
        chord.highlightColor = relmode.color;
        chord.highlightPower = 0.3;
    }   
}

/**
 * 
 * @returns {} 
 */
function highlightChordsLinear() {
    var tonic = chordDefinitions.find(_t => _t.isTonicChord(circleParameters.selectedTonic,
         circleParameters.isTonicMinor));

    //chord.isTonicChord(circleParameters.selectedTonic, circleParameters.isTonicMinor))

    for (let chord of chordDefinitions) {
        var relmode = chord.getRelativePosition(tonic);

        chord.highlight = ChordHighlightType.UnderlineModeQuality;

        switch (relmode) {
            //Tonic
        case -1:
        case 0:
        case 1:
            chord.highlightColor = 'rgb(204,255,214)';
            break;

        //Bright side
        case 2:
            chord.highlightColor = 'rgb(248,255,204)';
            break;
        case 3:
            chord.highlightColor = 'rgb(253,239,210)';
            break;
        case 4:
            chord.highlightColor = 'rgb(251,228,214)';
            break;
        case 5:
            chord.highlightColor = 'rgb(248,220,219)';
            break;

        //Dark side
        case -2:
            chord.highlightColor = 'rgb(205,246,252)';
            break;
        case -3:
            chord.highlightColor = 'rgb(219,231,253)';
            break;
        case -4:
            chord.highlightColor = 'rgb(225,226,247)';
            break;
        case -5:
            chord.highlightColor = 'rgb(237,229,244)';
            break;

        //Antiside
        case -6:
        case 6:
            chord.highlightColor = 'rgb(224,213,219)';
            break;

        default:

            chord.highlightColor = '#ffffff00';
            break;
        }

        chord.highlightPower = 1 - 0.8 * Math.abs(relmode) / 6.0;
        chord.active = true;
    }
}

/**
 * 
 * @returns {} 
 */
function highlightChordsPsychoaffective() {

    var tonic = chordDefinitions.find(_t => _t.isTonicChord(circleParameters.selectedTonic,
        circleParameters.isTonicMinor));

    for (let chord of chordDefinitions) {
        var relmode = chord.getRelativePosition(tonic);

        var amode = relmode < 0 ? 12 + relmode : relmode;

        if (tonic.minor && !chord.minor)
            amode += 9;
        else if (!tonic.minor && chord.minor)
            amode += 3;

        amode = (amode * 7) % 12;

        var col = harmonicColors.find(c => c.Steps == amode &&
            c.SourceMinor == tonic.minor &&
            c.TargetMinor == chord.minor);

        if (null == col)
            continue;

        chord.highlight = ChordHighlightType.UnderlineModeQuality;

        k = smoothstep(col.Valence, 2);

        if (k < 0) k = 0;
        else if (k > 1) k = 1;

        var colorfill = harmonicNeutralColor;

        if (k < 0.5)
            colorfill = lerpcolor(k * 2, harmonicNeutralColor, harmonicColdColor);
        else
            colorfill = lerpcolor((k - 0.5) * 2, harmonicWarmColor, harmonicNeutralColor);

        chord.highlightColor = 'rgb(' + colorfill.r + ',' + colorfill.g + ',' + colorfill.b + ')';
        chord.highlightPower = smoothstep(col.Potence, 1);
        chord.active = true;
    }
}